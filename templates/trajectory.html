{% extends 'base.html' %}
{% block title %}Редактирование траектории{% endblock %}
{% block head %}
    <style>
        .new-topic {
            background-color: rgb(245,255,245);
        }
    </style>
{% endblock head %}

{% block body %}
<div class="grid">
{% for topic in topics %}
<div class="row">
    <div class="col-md-5" style="padding-left: 1em">
        <div class="input-group">
        <span class="input-group-addon"><span class="glyphicon glyphicon-resize-vertical"></span></span>
        <input type="text" class="form-control existing-topic topic-name" placeholder="тема" value="{{ topic.name }}">
        </div>
    </div>
    <div class="col-md-2">
        <div class="input-group">
        <span class="input-group-addon"><span class="glyphicon glyphicon-education"></span></span>
        <input type="text" class="form-control topic-level" value="{{ topic.level }}">
        </div>
    </div>
    <div class="col-md-5">
        <div style="position: relative; bottom: 50%; transform: translateY(50%);" ><a href="{{ url_for('show_problems', topic = topic.name) }}"><span class="glyphicon glyphicon-book"></span> Задачи по теме</a></div>
    </div>
</div>
{% endfor %}
</div>

<div class="row">
    <div class="col-xs-4"><button class="btn btn-default" id="add">Добавить существующую тему</button></div>
    <div class="col-xs-4"><button class="btn btn-default" id="new">Добавить новую тему</button></div>
    <div class="col-xs-4"><button class="btn btn-default" id="save">Сохранить изменения</button><span id="result" class="badge"></span></div>
</div>

<script>
$(function(){
    $(".grid").sortable({
        tolerance: 'pointer',
        revert: 300,
        placeholder: 'span2 well placeholder tile',
        forceHelperSize: true
    });

    var autocomleteSettings = {
        mustMatch: true,
        source: function(request, response) {
            $.getJSON("{{ url_for('autocomplete_topics') }}",{
                q: request.term,
            }, function(data) {
                response(data.matching_results);
            });
        },
        minLength: 2
    };

    $("input.existing-topic").autocomplete(autocomleteSettings).bind( 'blur', function(){
        if(!this.value){
            $(this).closest('div.row').remove();
        }
    });

    $('button#add').bind('click', function() {
        var ni = document.createElement('div');
        ni.classList.add('row');
        ni.innerHTML = `
            <div class="col-md-5" style="padding-left: 1em">
                <div class="input-group">
                <span class="input-group-addon"><span class="glyphicon glyphicon-resize-vertical"></span></span>
                <input type="text" class="form-control existing-topic topic-name" placeholder="тема" value="">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                <span class="input-group-addon"><span class="glyphicon glyphicon-education"></span></span>
                <input type="text" class="form-control topic-level" placeholder="сложность" value="">
                </div>
            </div>
            <div class="col-md-5">
            </div>`;
        document.querySelector(".grid").appendChild(ni);
        $(ni).find("input.existing-topic").autocomplete(autocomleteSettings).bind( 'blur', function(){
            if(this.value == ''){
                $(this).closest('div.row').remove();
            }
        });
        ni.querySelector("input").focus();
    });

    $('button#new').bind('click', function() {
        var ni = document.createElement('div');
        ni.classList.add('row');
        ni.innerHTML = `
            <div class="col-md-5" style="padding-left: 1em">
                <div class="input-group">
                <span class="input-group-addon"><span class="glyphicon glyphicon-resize-vertical"></span></span>
                <input type="text" class="form-control new-topic topic-name" placeholder="тема" value="">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                <span class="input-group-addon"><span class="glyphicon glyphicon-education"></span></span>
                <input type="text" class="form-control topic-level" placeholder="сложность" value="">
                </div>
            </div>
            <div class="col-md-5">
            </div>`
        document.querySelector(".grid").appendChild(ni);
        $(ni).find("input.existing-topic").bind( 'blur', function(){
            if(this.value == ''){
                $(this).closest('div.row').remove();
            }
        });
    });

    $('button#save').bind('click', function() {
        var dataToSend = {'topics':'', 'levels': '', 'newtopics': ''};
        var allInputs = document.querySelector('.grid').querySelectorAll('input.topic-name');
        var allLevelInputs = document.querySelector('.grid').querySelectorAll('input.topic-level');
        for(var i = 0; i < allInputs.length; ++i){
            if(allInputs[i].classList.contains('new-topic')){
                allInputs[i].classList.remove('new-topic')
                allInputs[i].classList.add('existing-topic')
                if(dataToSend['newtopics'] && allInputs[i].value){
                    dataToSend['newtopics'] += '|';
                }
                if(allInputs[i].value){
                    dataToSend['newtopics'] += allInputs[i].value;
                }
            }
            if(dataToSend['topics'] && allInputs[i].value){
                dataToSend['topics'] += '|';
                dataToSend['levels'] += '|';
            }
            if(allInputs[i].value){
                dataToSend['topics'] += allInputs[i].value;
                dataToSend['levels'] += allLevelInputs[i].value;
            }
        }

        $.ajax({
            url: '{{ url_for("edit_trajectory") }}',
            data: JSON.stringify(dataToSend),
            contentType: 'application/json',
            type: 'POST',
            success: function(response) {
                $('span#result').text(response.result);
            }
        });
        return false;
    });
});
</script>
{% endblock body %}