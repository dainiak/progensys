{% extends 'base.html' %}

{% block head %}
<script type="text/javascript">
$(function(){
    $('button.btn-submit-for-review').click(function (evt) {
        if (!window.confirm('Вы прочитали документ по работе с дорешками по адресу https://goo.gl/2YQL5o и проверили, что решение оформлено в соответствии с правилами?'))
            return;

        $.ajax({
            type: "POST",
            url: "{{ url_for('solution_reviews.view_solution_review_requests', course_id=course_id) }}",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify({
                action: 'submit_for_review',
                user_id: {{ user_id }},
                problem_id: parseInt(evt.target.dataset.problemId),
                course_id: {{ course_id }}
            })
        }).done(function (response) {
            $.toaster({
                message : response.result.toString(),
                priority : 'success'
            });
        }).fail(function () {
            $.toaster({
                message : 'Не удалось сохранить изменения',
                priority : 'danger'
            });
        });
    });
    $('button.btn-mark-topic').click(function (evt) {
        $.ajax({
            type: "POST",
            url: "{{ url_for('exposures.mark_topic_priority_for_learner', course_id=course_id) }}",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify({
                action: evt.target.dataset.emo == ':(' ? 'mark_topic_as_unwanted' : 'mark_topic_as_favourable',
                user_id: {{ user_id }},
                topic_id: parseInt(evt.target.dataset.topicId),
                course_id: {{ course_id }}
            })
        }).done(function (response) {
            $.toaster({
                message : response.result.toString(),
                priority : 'success'
            });
        }).fail(function () {
            $.toaster({
                message : 'Не удалось сохранить изменения',
                priority : 'danger'
            });
        });
    });
});
</script>

<script src="/static/js/jquery.toaster.js"></script>

<style type="text/css">
    .opaque {
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block title %}Результаты{% endblock %}

{% block body %}
    <div class="container-fluid">
        {% if instructor_mode %}<h2 class="h2">Результаты пользователя {{ username }}</h2>{% else %}
        <div class="card">
        <a class="h4 card-header" href="https://goo.gl/2YQL5o" target="_blank">Справка по работе с информационной системой и дорешками</a>
        </div>{% endif %}
        <div class="card">
            <a class="h4 card-header" data-toggle="collapse" href="#exposuresAndGrading">Содержимое выдач и результаты проверок</a>
            <div class="card-body collapse" id="exposuresAndGrading">
                <table class="table table-sm table-striped">
                    <thead class="thead-default">
                    <tr>
                        <th>Дата и ID выдачи</th>
                        <th>ID набора задач</th>
                        <th>ID задач и результаты их проверки</th>
                    </tr>
                    </thead>
                    <tbody>{% for exposure in exposures %}<tr>
                        <td>{{ exposure.date }}, #{{ exposure.id }}</td>
                        <td>{{ exposure.problem_set_id }}</td>
                        <td>
{% if exposure.grading_results %}<table>
    <tr>{% for item in exposure.grading_results %}<td><a href="{{ url_for('problems.print_problem', problem_id=item.problem_id, course_id=course_id) }}">#{{ item.problem_id }}</a></td>{% endfor %}</tr><tr>
                            {% for item in exposure.grading_results %}<td class="center">{{ item.icon }}</td>{% endfor %}</tr></table>{% endif %}</td>
                    </tr>{% endfor %}</tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <a class="h4 card-header" data-toggle="collapse" href="#trajectoryProgress">Движение по траектории</a>
            <div class="card-body collapse" id="trajectoryProgress">
                <table class="table table-sm table-striped">
                    <thead class="thead-default">
                        <tr><th></th>
                        <th>ID темы</th>
                        <th>название/код темы</th>
                        <th>Задача, закрывшая тему</th>
                        </tr>
                    </thead>
                        <tbody>
                        {% for item in trajectory %}<tr>
                            <td><strong>{% if item.problem_id %}{% if item.is_on_revision %}<span class="opaque">&#x2713;</span>{% else %}&#x2714;{% endif %}{% else %}&#x2610;{% endif %}</strong></td><td>{{ item.topic_id }}</td><td>{% if item.topic_title %}{{ item.topic_title }}{% else %}{{ item.topic_code }}{% endif %}</td><td>{% if item.problem_id %}{{ item.problem_id }}{% else %}<div class="btn-group mr-2"><button class="btn btn-secondary btn-mark-topic" data-emo=":(" data-topic-id="{{ item.topic_id }}">отложить</button><button class="btn btn-success btn-mark-topic" data-emo=":)" data-topic-id="{{ item.topic_id }}">приоритизировать</button></div>{% endif %}</td>
                        </tr>{% endfor %}</tbody>
                </table>
            </div>
         </div>
        <div class="card">
            <a class="h4 card-header" data-toggle="collapse" href="#solutionRevisions">Дорешки в LaTeX</a>
            <div class="card-body collapse" id="solutionRevisions">
                <div class="card-block">
                <h5 class="card-title h5">Полезные ссылки</h5>
                    <ul>
                        <li class="list-group-item"><a href="{{ 'https://www.sharelatex.com/project/' + sharelatex_project_id }}">Ваш проект на ShareLaTeX</a></li>
                        <li class="list-group-item"><a href="http://www.dainiak.com/ilatexprimer/">Интерактивное введение в LaTeX</a></li>
                        <li class="list-group-item"><a href="http://www.dainiak.com/latexcheck/">Авточекер</a></li>
                        <li class="list-group-item"><a href="https://goo.gl/FhyJJm">Правила оформления решений</a></li>
                    </ul>
                </div>
                <div class="card-block">
                <h5 class="h5 card-title">Статус Ваших дорешек</h5>
                <table class="table table-sm table-striped">
                    <thead class="thead-default">
                    <tr>
                        <th>ID задачи</th>
                        <th>статус</th>
                        <th>действия</th>
                        <th>комментарии проверяющего</th>
                    </tr>
                    </thead>
                    <tbody>{% for item in revisions %}<tr>
                        <td><a href="{{ url_for('problems.print_problem', problem_id=item.problem_id, course_id=course_id) }}">#{{ item.problem_id }}</a></td>
                        <td>{{ item.review_status | safe }}</td>
                        <td>{% if item.submission_allowed %}<button class="btn btn-outline-secondary btn-submit-for-review" data-problem-id="{{ item.problem_id }}">запросить проверку</button>{% endif %}</td>
                        <td>{{ item.reviewer_comment }}</td>
                    </tr>{% endfor %}</tbody>
                </table>
                </div>
            </div>
         </div>
    </div>
{% endblock body %}