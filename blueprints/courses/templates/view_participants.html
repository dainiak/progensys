{% extends 'base.html' %}
{% block title %}Список участников курса {{ course_title }}{% endblock %}
{% block head %}
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css"/>
    <link type="text/css" rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

    <script src="/static/js/jquery.toaster.js"></script>


    <script>
        $(function () {
            $("#jsGrid").jsGrid({
                width: "100%",
                height: "auto",
                inserting: true,
                heading: true,
                filtering: true,
                sorting: true,
                paging: false,
                autoload: true,
                deleteConfirm: "Вы уверены, что хотите удалить пользователя из участников курса? История оценок при этом сохранится.",
                fields: [
                    {
                        title: "Группы",
                        name: "groups",
                        type: "text"
                    },
                    {
                        title: "Username",
                        name: "username",
                        type: "text"
                    },
                    {
                        title: "E-mail",
                        name: "email",
                        type: "text"
                    },
                    {
                        title: "Фамилия",
                        name: "name_last",
                        type: "text"
                    },
                    {
                        title: "Имя",
                        name: "name_first",
                        type: "text"
                    },
                    {
                        title: "Отчество",
                        name: "name_middle",
                        type: "text"
                    },
                    {
                        title: "Роль",
                        name: "role_id",
                        type: "select",
                        items: [{"role_id": "", "role_title": ""}].concat({{ roles | safe }}),
                        valueField: "role_id",
                        textField: "role_title"
                    },
                    {
                        type: "control",
                        modeSwitchButton: false,
                        editButton: false
                    }
                ],

                controller: {
                    loadData: function (filter) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'load',
                                filter: filter,
                                course_id: {{ course_id }}
                            })
                        });
                    },
                    insertItem: function (item) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'insert',
                                item: item,
                                course_id: {{ course_id }}
                            })
                        }).done(function () {
                            $.toaster({
                                message : 'Пользователь добавлен в участники курса',
                                priority : 'success'
                            });
                        }).fail(function () {
                            $.toaster({
                                message : 'Не удалось сохранить изменения',
                                priority : 'danger'
                            });
                        });
                    },
                    deleteItem: function (item) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'delete',
                                item: item,
                                course_id: {{ course_id }}
                            })
                        }).done(function () {
                            $.toaster({
                                message : 'Пользователь удалён из числа участников курса',
                                priority : 'success'
                            });
                        }).fail(function () {
                            $.toaster({
                                message : 'Не удалось сохранить изменения',
                                priority : 'danger'
                            });
                        });
                    }
                }
            });
        })
        ;
    </script>
{% endblock head %}

{% block body %}
    <h1>Управление участниками курса «{{ course_title }}»</h1>
    <div id="jsGrid"></div>
{% endblock body %}