{% extends 'base.html' %}
{% block title %}Список участников курса {{ course_title }}{% endblock %}
{% block head %}
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css"/>
    <link type="text/css" rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

{#    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>#}
{#    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/locale/ru.js"></script>#}

    <script src="/static/js/jquery.toaster.js"></script>


    <script>
        $(function () {
            $('#exposure-datetime').val((new Date()).toISOString().slice(0,16));
            $('#exposureTypeManual').change(function(){
                if($(this).prop('checked')){
                    $('#problemSetIDChooser').show();
                    $('#autogeneratedExposurePreambleChooser').hide();
                    $('#autogeneratedExposureMaxProblems').hide();
                }
            });
            $('#exposureTypeAuto').change(function(){
                if($(this).prop('checked')){
                    $('#problemSetIDChooser').hide();
                    $('#autogeneratedExposurePreambleChooser').show();
                    $('#autogeneratedExposureMaxProblems').show();
                }
            });
            $('#exposureSettingsModalOpen').click( function () {
                $('#userIDs').val(selectedItemIDs);
                $('#exposureSettingsModal').modal('show');
            });

            var selectedItemIDs = [];
            var allLoadedIDs = [];
            var $headerCheckbox = null;

            function updateSelectionHeader() {
                if(selectedItemIDs.length == 0) {
                    $headerCheckbox.prop("indeterminate", false).prop("checked", false);
                }
                else if(selectedItemIDs.length == allLoadedIDs.length &&
                    $.grep(selectedItemIDs, function(id) {
                        return $.inArray(id, allLoadedIDs) >= 0;
                    }).length == allLoadedIDs.length) {
                    $headerCheckbox.prop("indeterminate", false).prop("checked", true);
                }
                else {
                    $headerCheckbox.prop("checked", false).prop("indeterminate", true);
                }
            }

            function selectItem(item) {
                if($.inArray(item.user_id, selectedItemIDs) < 0){
                    selectedItemIDs.push(item.user_id);
                    updateSelectionHeader();
                }
            }

            function unselectItem(item) {
                selectedItemIDs = $.grep(selectedItemIDs, function(i) {
                    return i !== item.user_id;
                });
                updateSelectionHeader();
            }

            function selectAll(){
                selectedItemIDs = allLoadedIDs;
                $("#jsGrid").jsGrid("refresh");
            }

            function unselectAll(){
                selectedItemIDs = [];
                $("#jsGrid").jsGrid("refresh");
            }

            var trajectory_ids = [""].concat({{ trajectory_ids | safe }});
            for(var i = 0; i < trajectory_ids.length; ++i)
                trajectory_ids[i] = {'trajectory_id': trajectory_ids[i]}

            $("#jsGrid").jsGrid({
                width: "100%",
                height: "auto",
                inserting: true,
                heading: true,
                filtering: true,
                editing: true,
                sorting: true,
                paging: false,
                autoload: true,
                deleteConfirm: "Вы уверены, что хотите удалить пользователя из участников курса? История оценок при этом сохранится.",
                fields: [
                    {
                        headerTemplate: function() {
                            $headerCheckbox = $("<input>")
                                .attr("type", "checkbox")
                                .on("change", function(){
                                    $(this).is(":checked") ? selectAll() : unselectAll()
                                });
                            return $headerCheckbox;
                        },
                        itemTemplate: function(_, item) {
                            return $("<input>").attr("type", "checkbox")
                                    .prop("checked", $.inArray(item.user_id, selectedItemIDs) > -1)
                                    .on("change", function () {
                                        $(this).is(":checked") ? selectItem(item) : unselectItem(item);
                                    });
                        },
                        align: "center",
                        sorting: false,
                        width: 50
                    },
                    {
                        title: "ID",
                        name: "user_id",
                        type: "text"
                    },
                    {
                        title: "Группы",
                        name: "groups",
                        type: "text"
                    },
                    {
                        title: "Username",
                        name: "username",
                        type: "text",
                        itemTemplate: function(value, item) {
                            return $("<a>").attr('href', "{{ url_for('learner_dashboard.view_learner_dashboard', course_id=course_id, user_id='99999999') }}".replace('99999999', item.user_id)).text(value);
                        }
                    },
                    {
                        title: "E-mail",
                        name: "email",
                        type: "text"
                    },
                    {
                        title: "Фамилия",
                        name: "name_last",
                        type: "text"
                    },
                    {
                        title: "Имя",
                        name: "name_first",
                        type: "text"
                    },
                    {
                        title: "Отчество",
                        name: "name_middle",
                        type: "text"
                    },
                    {
                        title: "Роль",
                        name: "role_id",
                        type: "select",
                        items: [{"role_id": "", "role_title": ""}].concat({{ roles | safe }}),
                        valueField: "role_id",
                        textField: "role_title"
                    },
                    {
                        title: "Траектория",
                        name: "trajectory_id",
                        type: "select",
                        items: trajectory_ids,
                        valueField: "trajectory_id",
                        textField: "trajectory_id"
                    },
                    {
                        type: "control",
                        modeSwitchButton: false,
                        editButton: true
                    }
                ],

                controller: {
                    loadData: function (filter) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'load',
                                filter: filter,
                                course_id: {{ course_id }}
                            })
                        }).done(function (response) {
                            allLoadedIDs = [];
                            for(var t = 0; t < response.length; ++t){
                                allLoadedIDs.push(response[t].user_id);
                            }
                        });
                    },
                    insertItem: function (item) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'insert',
                                item: item,
                                course_id: {{ course_id }}
                            })
                        }).done(function () {
                            $.toaster({
                                message : 'Пользователь добавлен в участники курса',
                                priority : 'success'
                            });
                        }).fail(function () {
                            $.toaster({
                                message : 'Не удалось сохранить изменения',
                                priority : 'danger'
                            });
                        });
                    },
                    updateItem: function (item) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'update',
                                item: item,
                                course_id: {{ course_id }}
                            })
                        }).done(function () {
                            $.toaster({
                                message : 'Изменения сохранены',
                                priority : 'success'
                            });
                        }).fail(function () {
                            $.toaster({
                                message : 'Не удалось сохранить изменения',
                                priority : 'danger'
                            });
                        });
                    },
                    deleteItem: function (item) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/participant",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'delete',
                                item: item,
                                course_id: {{ course_id }}
                            })
                        }).done(function () {
                            $.toaster({
                                message : 'Пользователь удалён из числа участников курса',
                                priority : 'success'
                            });
                        }).fail(function () {
                            $.toaster({
                                message : 'Не удалось сохранить изменения',
                                priority : 'danger'
                            });
                        });
                    }
                },
                onItemEditing: function(args) {
                    if(args.item.role_id != 3) {
                        args.cancel = true;
                    }
                },
                rowClick: function () {
                    return false;
                },
                onRefreshed: function () {
                    updateSelectionHeader();
                }
            });
        });
    </script>
{% endblock head %}

{% block body %}
    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Управление участниками курса «{{ course_title }}»</h4>
                <div class="card-text">
                    Действия:
                    <div class="form-inline">
                        <button class="btn btn-secondary" id="exposureSettingsModalOpen">создать
                            выдачу
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="jsGrid" class="card"></div>

    </div>
    <div class="modal fade" id="exposureSettingsModal" tabindex="-1" role="dialog" aria-hidden="true"
         data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Параметры выдачи</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="exposureForm" action="{{ url_for('exposures.new_exposure') }}" method="post">
                    <input id="userIDs" name="user_ids" type="hidden" value="">
                    <input name="course_id" type="hidden" value="{{ course_id }}">
                    <div class="modal-body">
                        <div class="form">
                            <div class="form-group row">
                                <label for="exposure-datetime" class="col-2 col-form-label">Дата и время выдачи</label>
                                <div class="col-10"><input id="exposure-datetime" class="form-control"
                                                           type="datetime-local" name="exposure_timestamp"></div>
                            </div>
                            <div class="form-group row">
                                <label class="col-2 col-form-label" for="exposureTitleInput">Название выдачи</label>
                                <div class="col-10"><input type="text" class="form-control" id="exposureTitleInput"
                                                           placeholder="заголовок" name="exposure_title"></div>
                            </div>
                            <fieldset class="form-group">
                                <label>Тип выдачи</label>
                                <div class="form-check">
                                    <label class="form-check-label">
                                        <input type="radio" class="form-check-input" name="exposure_type"
                                               id="exposureTypeAuto" value="auto" checked>
                                        автоматическая генерация
                                    </label>
                                </div>
                                <div class="form-check">
                                    <label class="form-check-label">
                                        <input type="radio" class="form-check-input" name="exposure_type"
                                               id="exposureTypeManual" value="manual">
                                        фиксированный набор задач
                                    </label>
                                </div>
                            </fieldset>
                            <div id="problemSetIDChooser" class="form-group row" style="display:none">
                                <label class="col-2 col-form-label" for="problemSetID">ID набора задач</label>
                                <div class="col-10"><input type="number" class="form-control" id="problemSetID"
                                                           name="problem_set_id"
                                                           placeholder="ID"></div>
                            </div>
                            <div id="autogeneratedExposureMaxProblems" class="form-group row">
                                <label class="col-2 col-form-label" for="maxProblemsPerSet">Число задач в варианте</label>
                                <div class="col-10"><input type="number" class="form-control" id="maxProblemsPerSet" name="max_problems_per_set" value="5"></div>
                            </div>

                            <div id="autogeneratedExposurePreambleChooser" class="form-group row">
                                <label class="col-2 col-form-label" for="problemSetID">Преамбула (опционально)</label>
                                <textarea class="col-10 form-control" id="exposurePreamble"
                                                              name="exposure_preamble"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                        <button type="submit" class="btn btn-secondary button-create-exposure">Создать выдачу</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock body %}