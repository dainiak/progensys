{% extends 'base.html' %}
{% block title %}Результаты{% endblock %}
{% block head %}
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css"/>
    <link type="text/css" rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

    <script>
        $(function () {
            var exposure_ids = {{ exposure_ids | safe }};
            var all_problems = {{ all_problems | safe }}.sort();
            var user_ids = {{ user_ids | safe }};

            function getSingleProblemFields(){
                var list = [];

                for(var i = 1; i <= 5; ++i){
                    var items = {{ problem_statuses | safe }};
                    for( var j = 0; j < all_problems.length; ++j ){
                        items.push({
                            name: "(" + all_problems[j].toString() + ")",
                            id: -all_problems[j]
                        });
                    }

                    list.push({
                        title: "Задача " + i.toString(),
                        name: "p" + i.toString(),
                        type: "select",
                        items: items,
                        valueField: "id",
                        textField: "name"
                    });
                }
                return list;
            }

            var problemFields = getSingleProblemFields();
            var fields = [
                        {
                            title: "ID теста",
                            name: "exposure_id",
                            itemTemplate: function(value) {
                                return $("<span>").text(value);
                            },
                            filtering: false
                        },
                        {
                            title: "Дата",
                            name: "exposure_date",
                            itemTemplate: function(value) {
                                return $("<span>").text(value);
                            },
                            filtering: false
                        },
                        {
                            title: "Студент",
                            name: "learner_name",
                            itemTemplate: function(value) {
                                return $("<span>").text(value);
                            },
                            filtering: false
                        },
                        {
                            title: "ID набора",
                            name: "problem_set_id",
                            itemTemplate: function(value) {
                                return $("<span>").text(value);
                            },
                            filtering: false
                        }
                    ].concat(problemFields).concat([{type: "control", modeSwitchButton: false, editButton: true, deleteButton: false}]);

            $("#jsGrid").jsGrid({
                width: "100%",
                height: "auto",
                inserting: false,
                heading: true,
                editing: true,
                filtering: false,
                sorting: true,
                paging: false,
                autoload: true,
                fields: fields,
                controller: {
                    loadData: function (filter) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/grading",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                action: 'load',
                                filter: filter,
                                exposure_ids: exposure_ids,
                                user_ids: user_ids})
                        });
                    },
                    updateItem: function (item) {
                        return $.ajax({
                            type: "POST",
                            url: "/api/grading",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({action: 'update', item: item})
                        });
                    }
                }
            });
        })
        ;
    </script>
{% endblock head %}

{% block body %}
    <div id="jsGrid"></div>
{% endblock body %}